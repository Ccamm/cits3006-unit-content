# Lab 2: Malware (NOT READY)

{% hint style="danger" %}
READ: Any knowledge and techniques presented here are for your learning purposes only. It is **ABSOLUTELY ILLEGAL** to apply the learned knowledge to others without proper consent/permission, and even then, you must check and comply with any regulatory restrictions and laws.
{% endhint %}

In this lab, we will setup a dummy malware on a Windows machine. To do this lab, we will require two VMs (don't have to be running at the same time) - Kali and Windows.

## 2.0. Setup Windows 10 VM

You can select and download Windows 10 ISO from their official website:

```
https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/
```

or if you have Apple Silicon go here and select Windows (also follow the instructions there):

```
https://mac.getutm.app/gallery/
```

{% hint style="warning" %}
Please be advised that the size of the ISO is \~6GB!&#x20;
{% endhint %}

{% hint style="info" %}
The default login and password are `IEUser`/`Passw0rd!`
{% endhint %}

Once downloaded, you can install it on your VMM. We just need the Windows running (no specific software or settings required) so you can do the minimal setup where feasible. The VM comes with 90 days trial license, but you can take a snapshot after setting up, so you can _refresh_ the expiry date.&#x20;

## 2.1. Persistent Malware

In this lab, we will have a look at how to make the malware persistent on the Windows machine. One of the simplest ways of achieving this is to modify the registry keys. Registry keys, specifically the "Run keys", can be configured and are executed when the user logs in.

The following run keys are created by Windows:

* `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce`

{% hint style="info" %}
In the command, replace `HKEY_CURRENT_USER` with `HKCU` and `HKEY_LOCAL_MACHINE` with `HKLM`
{% endhint %}

![](<../.gitbook/assets/image (4).png>)

The listed keys may be different but that is not an issue, what we are interested in is how those keys change when we modify them later. Because those keys are running every time the user logs in, we can attach malware to the run keys then it will become (virtually) permanent!

Now, let's use a simple malware(?) code, which you can get from here:

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/windows_malware.cpp
```

The code actually doesn't do much other than display a message box. If it is placed into the run keys, then you will be greeted with the message every time you log in. Since the code needs to run on Windows machine, you have to compile for the target machine environment:

```
sudo apt-get install g++-mingw-w64-x86-64 -y
```

```
x86_64-w64-mingw32-g++ -O2 windows_malware.cpp -o bad.exe -mwindows -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
```

![](<../.gitbook/assets/image (9).png>)

Now move the executable `bad.exe` to your target Windows 10 VM. You can also download a copy here:

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/bad.exe
```

Create a folder `test` inside the C drive i.e., `C:/test/bad.exe` (you can technically save it anywhere, but other scripts will use a hard-coded path so if you don't want to modify the path etc., use this instead). You can also execute it for testing - it should pop up a message box.

![](<../.gitbook/assets/image (10).png>)

The `bad.exe` only shows the message box, so we have to create a program that will insert this executable file into the registry keys. This is achieved using the `registry_script.cpp`.

```
wget https://raw.githubusercontent.com/uwacyber/cits3006/2022s2/cits3006-labs/files/registry_script.cpp
```

{% hint style="info" %}
Inspect the `registry_script.cpp` and see how easy it is to modify the registry key!
{% endhint %}

Now compile the script:

```
x86_64-w64-mingw32-g++ -O2 registry_script.cpp -o bad_script.exe -I/usr/share/mingw-w64/include/ -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc -fpermissive
```











